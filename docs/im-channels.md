# IM é€šé“é›†æˆæŒ‡å—

OpenAkita æ”¯æŒå¤šä¸ªå³æ—¶é€šè®¯å¹³å°ï¼Œæ¯ä¸ªå¹³å°é€šè¿‡ç‹¬ç«‹çš„é€‚é…å™¨ (Adapter) æ¥å…¥ç»Ÿä¸€çš„æ¶ˆæ¯ç½‘å…³ (MessageGateway)ã€‚

## å¹³å°æ¦‚è§ˆ

| å¹³å° | çŠ¶æ€ | æ¥å…¥æ–¹å¼ | éœ€è¦å…¬ç½‘ IP | å®‰è£…å‘½ä»¤ |
|------|------|---------|------------|---------|
| Telegram | âœ… ç¨³å®š | Long Polling | âŒ ä¸éœ€è¦ | é»˜è®¤åŒ…å« |
| é£ä¹¦ | âœ… ç¨³å®š | WebSocket é•¿è¿æ¥ | âŒ ä¸éœ€è¦ | `pip install openakita[feishu]` |
| é’‰é’‰ | âœ… ç¨³å®š | Stream æ¨¡å¼ (WebSocket) | âŒ ä¸éœ€è¦ | `pip install openakita[dingtalk]` |
| ä¼ä¸šå¾®ä¿¡ | âœ… ç¨³å®š | HTTP å›è°ƒï¼ˆæ™ºèƒ½æœºå™¨äººï¼‰ | âš ï¸ éœ€è¦å…¬ç½‘ IP | `pip install openakita[wework]` |
| QQ | ğŸ§ª Beta | OneBot WebSocket | âŒ ä¸éœ€è¦ | `pip install openakita[qq]` |

## åª’ä½“ç±»å‹æ”¯æŒçŸ©é˜µ

### æ¥æ”¶æ¶ˆæ¯ (å¹³å° â†’ OpenAkita)

| ç±»å‹ | Telegram | é£ä¹¦ | é’‰é’‰ | ä¼ä¸šå¾®ä¿¡ | QQ |
|------|----------|------|------|---------|-----|
| æ–‡å­— | âœ… | âœ… | âœ… | âœ… | âœ… |
| å›¾ç‰‡ | âœ… | âœ… | âœ… | âš ï¸ ä»…å•èŠ | âœ… |
| è¯­éŸ³ | âœ… (Whisperè½¬å†™) | âœ… (Whisperè½¬å†™) | âœ… (Whisperè½¬å†™) | âŒ ä¸æ”¯æŒ | âœ… (Whisperè½¬å†™) |
| æ–‡ä»¶ | âœ… | âœ… | âœ… | âŒ ä¸æ”¯æŒ | âœ… |
| è§†é¢‘ | âœ… | âœ… | âœ… | âŒ ä¸æ”¯æŒ | âœ… |

### å‘é€æ¶ˆæ¯ (OpenAkita â†’ å¹³å°)

| æ–¹æ³• | Telegram | é£ä¹¦ | é’‰é’‰ | ä¼ä¸šå¾®ä¿¡ | QQ |
|------|----------|------|------|---------|-----|
| send_text | âœ… | âœ… | âœ… | âœ… (stream è¢«åŠ¨å›å¤) | âœ… |
| send_image | âœ… | âœ… | âœ… | âœ… (stream msg_item, base64+md5) | âœ… |
| send_file | âœ… | âœ… | âœ… (é™çº§ä¸ºé“¾æ¥) | âŒ é™çº§ä¸ºæ–‡æœ¬ | âœ… (upload_file API) |
| send_voice | âœ… | âœ… | âœ… (é™çº§ä¸ºæ–‡ä»¶) | âŒ ä¸æ”¯æŒ | âœ… (record) |

> **ä¼ä¸šå¾®ä¿¡é™åˆ¶è¯´æ˜**ï¼šæ™ºèƒ½æœºå™¨äººé€šè¿‡ stream æµå¼è¢«åŠ¨å›å¤å‘é€æ–‡æœ¬å’Œå›¾ç‰‡ï¼ˆJPG/PNGï¼Œâ‰¤10MBï¼Œå•æ¡æœ€å¤š 10 å¼ ï¼‰ã€‚**ä¸æ”¯æŒè¯­éŸ³ã€æ–‡ä»¶å’Œè§†é¢‘çš„æ”¶å‘**ã€‚æ¥æ”¶ç«¯ä»…æ”¯æŒæ–‡å­—ã€å›¾æ–‡æ··æ’å’Œå›¾ç‰‡ï¼ˆå›¾ç‰‡ä»…å•èŠï¼‰ã€‚response_url ä½œä¸º stream ä¸å¯ç”¨æ—¶çš„é™çº§æ–¹æ¡ˆï¼ˆä»…æ–‡æœ¬ï¼‰ã€‚

> **æ³¨æ„**: å›¾ç‰‡å’Œè¯­éŸ³ç”± MessageGateway è‡ªåŠ¨ä¸‹è½½å¹¶é¢„å¤„ç†ã€‚è¯­éŸ³ä¼šè‡ªåŠ¨é€šè¿‡ Whisper è½¬å†™ä¸ºæ–‡æœ¬ã€‚æ–‡ä»¶å’Œè§†é¢‘ä¸ä¼šè‡ªåŠ¨ä¸‹è½½ï¼Œéœ€è¦é€šè¿‡ `deliver_artifacts` å·¥å…·ä¸»åŠ¨å¤„ç†ã€‚

---

## Telegram

### å‰ç½®æ¡ä»¶

- ä¸€ä¸ª Telegram è´¦å·
- ç½‘ç»œèƒ½è®¿é—® Telegram APIï¼ˆå¤§é™†ç¯å¢ƒéœ€è¦ä»£ç†ï¼‰

### å¹³å°ä¾§é…ç½®

1. **åˆ›å»ºæœºå™¨äºº**: åœ¨ Telegram ä¸­æœç´¢ [@BotFather](https://t.me/BotFather)ï¼Œå‘é€ `/newbot`
2. **è·å– Token**: æŒ‰æç¤ºè®¾ç½®åç§°åï¼ŒBotFather ä¼šè¿”å›ä¸€ä¸ª Bot Tokenï¼ˆæ ¼å¼å¦‚ `123456:ABC-DEF...`ï¼‰
3. **ï¼ˆå¯é€‰ï¼‰è®¾ç½®å‘½ä»¤**: å‘é€ `/setcommands` é…ç½®æœºå™¨äººå‘½ä»¤èœå•

### OpenAkita é…ç½®

```bash
# .env
TELEGRAM_ENABLED=true
TELEGRAM_BOT_TOKEN=ä½ çš„Bot Token

# ä»£ç†ï¼ˆå¤§é™†ç¯å¢ƒéœ€è¦ï¼‰
TELEGRAM_PROXY=http://127.0.0.1:7890
# æˆ– socks5://127.0.0.1:1080
```

### éƒ¨ç½²æ¨¡å¼

- **Long Pollingï¼ˆé»˜è®¤ï¼‰**: æ— éœ€å…¬ç½‘ IPï¼Œé€‚é…å™¨ä¸»åŠ¨è½®è¯¢ Telegram æœåŠ¡å™¨è·å–æ¶ˆæ¯
- **Webhook**: éœ€è¦å…¬ç½‘ HTTPS URLï¼Œé…ç½® `TELEGRAM_WEBHOOK_URL`

### éªŒè¯æ–¹æ³•

1. å¯åŠ¨ OpenAkita åï¼Œåœ¨ Telegram ä¸­æ‰¾åˆ°ä½ çš„æœºå™¨äºº
2. å‘é€ `/start`ï¼Œåº”è¯¥æ”¶åˆ°é…å¯¹ç æç¤º
3. å‘é€é…å¯¹ç å®Œæˆé…å¯¹ï¼ˆå¦‚æœå¯ç”¨äº† `TELEGRAM_REQUIRE_PAIRING`ï¼‰
4. å‘é€ä»»æ„æ¶ˆæ¯ï¼Œè§‚å¯Ÿæ—¥å¿—è¾“å‡ºå’Œæœºå™¨äººå›å¤

### ç‰¹æœ‰åŠŸèƒ½

- é…å¯¹å®‰å…¨æœºåˆ¶ï¼ˆé˜²æ­¢æœªæˆæƒè®¿é—®ï¼‰
- å…¨åª’ä½“ç±»å‹æ”¯æŒæœ€å®Œæ•´
- Markdown æ ¼å¼æ¶ˆæ¯
- å†…è”é”®ç›˜

---

## é£ä¹¦ (Lark)

### å‰ç½®æ¡ä»¶

- ä¼ä¸šé£ä¹¦è´¦å·
- åœ¨ [é£ä¹¦å¼€å‘è€…åå°](https://open.feishu.cn/) åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨

### å¹³å°ä¾§é…ç½®

1. **åˆ›å»ºåº”ç”¨**: è¿›å…¥ [å¼€å‘è€…åå°](https://open.feishu.cn/app) â†’ åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨
2. **è·å–å‡­è¯**: åœ¨ã€Œå‡­è¯ä¸åŸºç¡€ä¿¡æ¯ã€é¡µé¢è·å– App ID å’Œ App Secret
3. **é…ç½®æƒé™**: åœ¨ã€Œæƒé™ç®¡ç†ã€ä¸­æ·»åŠ ä»¥ä¸‹æƒé™ï¼š
   - `im:message` â€” è·å–ä¸å‘é€æ¶ˆæ¯
   - `im:message.create_v1` â€” ä»¥åº”ç”¨èº«ä»½å‘æ¶ˆæ¯
   - `im:resource` â€” è·å–æ¶ˆæ¯ä¸­çš„èµ„æºæ–‡ä»¶
   - `im:file` â€” ä¸Šä¼ /ä¸‹è½½æ–‡ä»¶
4. **é…ç½®äº‹ä»¶è®¢é˜…**:
   - è¿›å…¥ã€Œäº‹ä»¶ä¸å›è°ƒã€é¡µé¢
   - **é€‰æ‹©ã€Œä½¿ç”¨é•¿è¿æ¥æ¥æ”¶äº‹ä»¶ã€**ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
   - æ·»åŠ äº‹ä»¶ï¼š`im.message.receive_v1`ï¼ˆæ¥æ”¶æ¶ˆæ¯ï¼‰
5. **å‘å¸ƒåº”ç”¨**: åœ¨ã€Œç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒã€ä¸­åˆ›å»ºç‰ˆæœ¬å¹¶å‘å¸ƒ

### OpenAkita é…ç½®

```bash
# å®‰è£…é£ä¹¦ä¾èµ–
pip install openakita[feishu]

# .env
FEISHU_ENABLED=true
FEISHU_APP_ID=cli_xxx
FEISHU_APP_SECRET=xxx
```

### éƒ¨ç½²æ¨¡å¼

- **WebSocket é•¿è¿æ¥ï¼ˆé»˜è®¤/æ¨èï¼‰**: æ— éœ€å…¬ç½‘ IPï¼ŒSDK è‡ªåŠ¨ç®¡ç†è¿æ¥å’Œé‡è¿
- æ¯ä¸ªåº”ç”¨æœ€å¤šæ”¯æŒ 50 ä¸ªé•¿è¿æ¥
- å¤šå®ä¾‹éƒ¨ç½²æ—¶ï¼Œæ¶ˆæ¯ä¼šéšæœºåˆ†å‘åˆ°å…¶ä¸­ä¸€ä¸ªè¿æ¥

### éªŒè¯æ–¹æ³•

1. å¯åŠ¨ OpenAkitaï¼Œæ—¥å¿—åº”æ˜¾ç¤º `Feishu adapter: WebSocket started in background`
2. åœ¨é£ä¹¦ä¸­æœç´¢å¹¶æ‰“å¼€æœºå™¨äººå¯¹è¯
3. å‘é€æ¶ˆæ¯ï¼Œè§‚å¯Ÿæ—¥å¿—å’Œæœºå™¨äººå›å¤

### å¸¸è§é—®é¢˜

- **æ¶ˆæ¯æ”¶ä¸åˆ°**: æ£€æŸ¥æ˜¯å¦åœ¨é£ä¹¦åå°å¯ç”¨äº†"é•¿è¿æ¥æ¨¡å¼"è€Œé Webhook
- **æƒé™ä¸è¶³**: ç¡®è®¤æ‰€æœ‰å¿…è¦æƒé™å·²ç”³è¯·ä¸”åº”ç”¨å·²å‘å¸ƒ
- **Token è¿‡æœŸ**: SDK ä¼šè‡ªåŠ¨ç®¡ç† Token åˆ·æ–°ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†

---

## é’‰é’‰

### å‰ç½®æ¡ä»¶

- ä¼ä¸šé’‰é’‰è´¦å·
- åœ¨ [é’‰é’‰å¼€å‘è€…åå°](https://open-dev.dingtalk.com/) åˆ›å»ºåº”ç”¨

### å¹³å°ä¾§é…ç½®

1. **åˆ›å»ºåº”ç”¨**: è¿›å…¥ [å¼€å‘è€…åå°](https://open-dev.dingtalk.com/) â†’ åº”ç”¨å¼€å‘ â†’ ä¼ä¸šå†…éƒ¨å¼€å‘ â†’ åˆ›å»ºåº”ç”¨
2. **è·å–å‡­è¯**: åœ¨ã€ŒåŸºç¡€ä¿¡æ¯ã€â†’ã€Œåº”ç”¨å‡­è¯ã€ä¸­è·å– AppKey å’Œ AppSecret
3. **é…ç½®æœºå™¨äºº**:
   - è¿›å…¥ã€Œåº”ç”¨åŠŸèƒ½ã€â†’ã€Œæœºå™¨äººã€
   - å¼€å¯æœºå™¨äººåŠŸèƒ½
   - **æ¶ˆæ¯æ¥æ”¶æ¨¡å¼é€‰æ‹©ã€ŒStream æ¨¡å¼ã€**ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
4. **é…ç½®æƒé™**: æ ¹æ®éœ€è¦æ·»åŠ æ¶ˆæ¯ç›¸å…³æƒé™
5. **å‘å¸ƒåº”ç”¨**: å‘å¸ƒåº”ç”¨ç‰ˆæœ¬

### OpenAkita é…ç½®

```bash
# å®‰è£…é’‰é’‰ä¾èµ–
pip install openakita[dingtalk]

# .env
DINGTALK_ENABLED=true
DINGTALK_CLIENT_ID=xxx
DINGTALK_CLIENT_SECRET=xxx
```

### éƒ¨ç½²æ¨¡å¼

- **Stream æ¨¡å¼ï¼ˆWebSocketï¼‰**: æ— éœ€å…¬ç½‘ IPï¼Œé€šè¿‡ WebSocket é•¿è¿æ¥æ¥æ”¶æ¶ˆæ¯
- dingtalk-stream SDK è‡ªåŠ¨ç®¡ç†è¿æ¥ã€é‡è¿å’Œå¿ƒè·³

### éªŒè¯æ–¹æ³•

1. å¯åŠ¨ OpenAkitaï¼Œæ—¥å¿—åº”æ˜¾ç¤º `DingTalk Stream client starting...`
2. åœ¨é’‰é’‰ä¸­æœç´¢å¹¶æ‰“å¼€æœºå™¨äººå¯¹è¯ï¼ˆæˆ–åœ¨ç¾¤ä¸­ @æœºå™¨äººï¼‰
3. å‘é€æ¶ˆæ¯ï¼Œè§‚å¯Ÿæ—¥å¿—å’Œæœºå™¨äººå›å¤

### æ¶ˆæ¯å›å¤æ–¹å¼

- **Session Webhook**: æ”¶åˆ°æ¶ˆæ¯æ—¶ä¼šæºå¸¦ `sessionWebhook`ï¼Œç”¨äºå›å¤å½“å‰ä¼šè¯ï¼ˆæ¨èï¼‰
- **æœºå™¨äººå•èŠ API**: ä½¿ç”¨ `robot/oToMessages/batchSend` ä¸»åŠ¨å‘é€ï¼ˆéœ€è¦ç”¨æˆ· IDï¼‰

### å¸¸è§é—®é¢˜

- **æ”¶ä¸åˆ°æ¶ˆæ¯**: ç¡®è®¤åœ¨é’‰é’‰åå°å·²é€‰æ‹© Stream æ¨¡å¼ï¼ˆä¸æ˜¯ HTTP æ¨¡å¼ï¼‰
- **Stream è¿æ¥å¤±è´¥**: æ£€æŸ¥ AppKey å’Œ AppSecret æ˜¯å¦æ­£ç¡®
- **å›¾ç‰‡/æ–‡ä»¶å‘é€**: é’‰é’‰æœºå™¨äººæ¶ˆæ¯å¯¹å¯Œåª’ä½“æ”¯æŒæœ‰é™ï¼Œéƒ¨åˆ†ä¼šé™çº§ä¸ºé“¾æ¥

---

## ä¼ä¸šå¾®ä¿¡

é€šè¿‡**æ™ºèƒ½æœºå™¨äºº**æ¥å…¥ä¼ä¸šå¾®ä¿¡ï¼Œé…ç½®ç®€å•ï¼Œä¸éœ€è¦å¤‡æ¡ˆåŸŸåã€‚

### å‰ç½®æ¡ä»¶

- ä¼ä¸šå¾®ä¿¡ç®¡ç†å‘˜è´¦å·
- **å…¬ç½‘å¯è®¿é—®çš„ URL**ï¼ˆIP å³å¯ï¼Œä¸éœ€è¦å¤‡æ¡ˆåŸŸåï¼‰
- **å…ˆåœ¨ `.env` ä¸­é…å¥½ä¼ä¸šå¾®ä¿¡å‚æ•°ï¼Œå†å»åå°åˆ›å»ºæœºå™¨äºº**ï¼ˆåˆ›å»ºæ—¶ä¼šéªŒè¯å›è°ƒè¿é€šæ€§ï¼‰

### å¹³å°ä¾§é…ç½®

> âš ï¸ **é‡è¦**ï¼šåˆ›å»ºæœºå™¨äººæ—¶ä¼ä¸šå¾®ä¿¡ä¼šç«‹å³å‘å›è°ƒ URL å‘é€ GET éªŒè¯è¯·æ±‚ï¼Œæ‰€ä»¥å¿…é¡»å…ˆåœ¨æœ¬åœ°é…å¥½å¹¶å¯åŠ¨ OpenAkitaï¼Œç¡®ä¿å›è°ƒç«¯å£å¯ä»å…¬ç½‘è®¿é—®ï¼Œç„¶åå†åˆ›å»ºæœºå™¨äººã€‚

1. **è·å–ä¼ä¸š ID (Corp ID)**: è¿›å…¥ [ä¼ä¸šå¾®ä¿¡ç®¡ç†åå°](https://work.weixin.qq.com/) â†’ã€Œæˆ‘çš„ä¼ä¸šã€â†’ã€Œä¼ä¸šä¿¡æ¯ã€é¡µé¢åº•éƒ¨
2. **åœ¨ `.env` ä¸­å¡«å¥½é…ç½®**ï¼ˆè§ä¸‹æ–¹ OpenAkita é…ç½®ï¼‰ï¼Œå¯åŠ¨ OpenAkita
3. **åˆ›å»ºæ™ºèƒ½æœºå™¨äºº**: åº”ç”¨ç®¡ç† â†’ æ™ºèƒ½æœºå™¨äºº â†’ åˆ›å»º
4. **é…ç½®å›è°ƒåœ°å€**:
   - åœ¨æœºå™¨äººé…ç½®é¡µé¢ â†’ ã€Œæ¥æ”¶æ¶ˆæ¯æœåŠ¡å™¨é…ç½®ã€
   - **URL**: å¡«å†™å›è°ƒåœ°å€ï¼Œå¦‚ `http://your-ip:9880/callback`
   - **Token**: è‡ªåŠ¨ç”Ÿæˆæˆ–è‡ªå®šä¹‰ï¼Œè®°ä¸‹æ¥å¡«å…¥ `.env`
   - **EncodingAESKey**: è‡ªåŠ¨ç”Ÿæˆæˆ–è‡ªå®šä¹‰ï¼Œè®°ä¸‹æ¥å¡«å…¥ `.env`
   - ç‚¹å‡»ä¿å­˜ï¼ˆä¼ä¸šå¾®ä¿¡ä¼šå‘é€ GET éªŒè¯è¯·æ±‚åˆ° URLï¼Œéœ€ç¡®ä¿å·²è¿é€šï¼‰
5. **è®¾ç½®å¯è§èŒƒå›´**ï¼ˆå¿…é¡»ï¼ï¼‰:
   - åœ¨æœºå™¨äººé…ç½®é¡µé¢ â†’ ã€Œå¯è§èŒƒå›´ã€
   - æ·»åŠ éœ€è¦ä½¿ç”¨æœºå™¨äººçš„éƒ¨é—¨æˆ–å‘˜å·¥
   - **åªæœ‰åœ¨å¯è§èŒƒå›´å†…çš„ä¼ä¸šæˆå‘˜æ‰èƒ½ä½¿ç”¨æœºå™¨äºº**
   - ä¼ä¸šå¤–éƒ¨äººå‘˜ï¼ˆå®¢æˆ·ã€ä¾›åº”å•†ç­‰ï¼‰æ— æ³•ä½¿ç”¨

### æƒé™ä¸ä½¿ç”¨èŒƒå›´

| åœºæ™¯ | æ˜¯å¦å¯ç”¨ | è¯´æ˜ |
|------|---------|------|
| å¯è§èŒƒå›´å†…çš„å‘˜å·¥å•èŠ | âœ… | ç›´æ¥åœ¨æœºå™¨äººå¯¹è¯ä¸­å‘æ¶ˆæ¯ |
| å¯è§èŒƒå›´å†…çš„å‘˜å·¥ç¾¤èŠ @æœºå™¨äºº | âœ… | ç¾¤èŠä¸­ @æœºå™¨äººè§¦å‘å›å¤ |
| **ä¸åœ¨å¯è§èŒƒå›´çš„å‘˜å·¥** | âŒ | çœ‹ä¸åˆ°æœºå™¨äººï¼Œæ— æ³•ä½¿ç”¨ |
| **ä¼ä¸šå¤–éƒ¨äººå‘˜** | âŒ | å¤–éƒ¨è”ç³»äººã€å®¢æˆ·ç¾¤ä¸­çš„éä¼ä¸šæˆå‘˜æ— æ³•è§¦å‘æœºå™¨äºº |

> **ç¾¤èŠä½¿ç”¨**ï¼šå°†æœºå™¨äººæ‹‰å…¥ç¾¤èŠåï¼Œ**åªæœ‰åœ¨å¯è§èŒƒå›´å†…çš„ä¼ä¸šæˆå‘˜** @æœºå™¨äººæ‰ä¼šè§¦å‘å›å¤ã€‚æ¯ä¸ª @æœºå™¨äººçš„ç”¨æˆ·ä¼šåˆ›å»ºç‹¬ç«‹çš„ä¼šè¯ sessionï¼Œäº’ä¸å¹²æ‰°ã€‚

### OpenAkita é…ç½®

```bash
# å®‰è£…ä¼ä¸šå¾®ä¿¡ä¾èµ–
pip install openakita[wework]

# .env
WEWORK_ENABLED=true
WEWORK_CORP_ID=ww_xxx

# å›è°ƒåŠ è§£å¯†ï¼ˆå¿…å¡«ï¼åœ¨æœºå™¨äººé…ç½®é¡µè·å–ï¼‰
WEWORK_TOKEN=xxx
WEWORK_ENCODING_AES_KEY=xxx
WEWORK_CALLBACK_PORT=9880
```

### æ¶ˆæ¯å›å¤æœºåˆ¶

æ™ºèƒ½æœºå™¨äººä½¿ç”¨ **stream æµå¼è¢«åŠ¨å›å¤**å‘é€æ¶ˆæ¯ï¼š

1. ç”¨æˆ·å‘æ¶ˆæ¯ â†’ ä¼ä¸šå¾®ä¿¡æ¨é€åŠ å¯† JSON åˆ°å›è°ƒ URL
2. OpenAkita è¢«åŠ¨å›å¤åˆå§‹ streamï¼ˆ`finish=false`ï¼Œåˆ›å»ºæµå¼ä¼šè¯ï¼‰
3. ä¼ä¸šå¾®ä¿¡å®šæ—¶å‘é€ `msgtype=stream` çš„åˆ·æ–°è¯·æ±‚
4. Agent å¤„ç†å®Œæˆ â†’ å†…å®¹å†™å…¥ stream session â†’ ä¸‹æ¬¡åˆ·æ–°æ—¶è¿”å› `finish=true` + å®Œæ•´å†…å®¹

**stream å›å¤èƒ½åŠ›**:
- **æ–‡æœ¬**: é€šè¿‡ `stream.content` å­—æ®µå‘é€ markdown æ–‡æœ¬
- **å›¾ç‰‡**: é€šè¿‡ `stream.msg_item` å­—æ®µå‘é€ï¼ˆbase64+md5ï¼‰ï¼Œæ”¯æŒ JPG/PNGï¼Œâ‰¤10MBï¼Œå•æ¡æœ€å¤š 10 å¼ 
- **æ–‡ä»¶/è¯­éŸ³**: ä¸æ”¯æŒ

**response_url é™çº§**:
- å½“ stream session è¶…æ—¶ï¼ˆ5.5 åˆ†é’Ÿï¼‰æˆ–ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨é™çº§åˆ° response_url å‘é€çº¯æ–‡æœ¬
- response_url æœ‰æ•ˆæœŸ 1 å°æ—¶ï¼Œä»…å¯è°ƒç”¨ä¸€æ¬¡ï¼Œä»…æ”¯æŒ text/markdown

**ç¾¤èŠ session éš”ç¦»**:
- ç¾¤èŠä¸­æ¯ä¸ªç”¨æˆ·çš„ @æ¶ˆæ¯ä¼šåˆ›å»ºç‹¬ç«‹çš„ stream session
- ç”¨æˆ· A å’Œç”¨æˆ· B åŒæ—¶ @æœºå™¨äººï¼Œå„è‡ªçš„å›å¤äº’ä¸å¹²æ‰°
- å›å¤è·¯ç”±é€šè¿‡ `chat_id + user_id` ç²¾ç¡®åŒ¹é…ï¼Œä¸ä¼šä¸²åˆ°å…¶ä»–ç”¨æˆ·

### æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

**æ¥æ”¶æ¶ˆæ¯** (ç”¨æˆ· â†’ æœºå™¨äºº):

| ç±»å‹ | ç¾¤èŠ | å•èŠ | è¯´æ˜ |
|------|------|------|------|
| æ–‡æœ¬ | âœ… (@æœºå™¨äºº) | âœ… | |
| å›¾æ–‡æ··æ’ | âœ… (@æœºå™¨äºº) | âœ… | |
| å›¾ç‰‡ | âŒ | âœ… | |
| è¯­éŸ³ | âŒ | âŒ | ä¸æ”¯æŒæ¥æ”¶ |
| æ–‡ä»¶ | âŒ | âŒ | ä¸æ”¯æŒæ¥æ”¶ |
| å¼•ç”¨æ¶ˆæ¯ | âœ… (@æœºå™¨äºº) | âœ… | |

> **æ³¨æ„**: å›¾ç‰‡çš„ä¸‹è½½ URL ç» AES åŠ å¯†ä¸”ä»… 5 åˆ†é’Ÿæœ‰æ•ˆï¼Œé€‚é…å™¨ä¼šè‡ªåŠ¨å¤„ç†è§£å¯†ã€‚

**å‘é€æ¶ˆæ¯** (æœºå™¨äºº â†’ ç”¨æˆ·):

| ç±»å‹ | æ”¯æŒ | è¯´æ˜ |
|------|------|------|
| æ–‡æœ¬/Markdown | âœ… | stream è¢«åŠ¨å›å¤ï¼ˆæ–‡æœ¬+å›¾ç‰‡ï¼‰ |
| å›¾ç‰‡ | âœ… | stream msg_itemï¼ˆbase64+md5ï¼ŒJPG/PNGï¼Œâ‰¤10MBï¼‰ |
| æ–‡ä»¶ | âŒ | ä¸æ”¯æŒï¼Œé™çº§ä¸ºæ–‡æœ¬æè¿° |
| è¯­éŸ³ | âŒ | ä¸æ”¯æŒ |

### éªŒè¯æ–¹æ³•

1. åœ¨ `.env` ä¸­é…å¥½å‚æ•°ï¼Œå¯åŠ¨ OpenAkitaï¼Œæ—¥å¿—åº”æ˜¾ç¤º `WeWorkBot adapter started`
2. ç¡®ä¿å›è°ƒ URL å¯ä»å…¬ç½‘è®¿é—®ï¼ˆå›è°ƒç«¯å£å·²ç›‘å¬ï¼‰
3. å»ä¼ä¸šå¾®ä¿¡ç®¡ç†åå°åˆ›å»ºæ™ºèƒ½æœºå™¨äººï¼Œé…ç½®å›è°ƒåœ°å€
4. **è®¾ç½®å¯è§èŒƒå›´**ï¼Œæ·»åŠ éœ€è¦ä½¿ç”¨çš„å‘˜å·¥/éƒ¨é—¨
5. åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ‰¾åˆ°æ™ºèƒ½æœºå™¨äººå¹¶å‘æ¶ˆæ¯ï¼Œæˆ–æ‹‰å…¥ç¾¤èŠå @æœºå™¨äºº
6. è§‚å¯Ÿæ—¥å¿—ä¸­çš„æ¶ˆæ¯è§£å¯†å’Œå¤„ç†è®°å½•

### å…¬ç½‘è®¿é—®

ä¼ä¸šå¾®ä¿¡ **ä¸æ”¯æŒ** WebSocket/é•¿è¿æ¥æ¨¡å¼ï¼Œåªèƒ½é€šè¿‡ HTTP å›è°ƒæ¥æ”¶æ¶ˆæ¯ã€‚

- **å…¬ç½‘æœåŠ¡å™¨**: ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œå›è°ƒ URL æŒ‡å‘æœåŠ¡å™¨ IP/åŸŸå
- **è·¯ç”±å™¨ç«¯å£è½¬å‘**: å¦‚æœ‰å…¬ç½‘ IPï¼Œåœ¨è·¯ç”±å™¨ä¸­å°†å¤–éƒ¨ç«¯å£è½¬å‘åˆ°æœ¬æœº IP çš„ 9880 ç«¯å£
- **å†…ç½‘ç©¿é€ï¼ˆæ— å…¬ç½‘ IPï¼‰**: ä½¿ç”¨ä»¥ä¸‹å·¥å…·å°†æœ¬åœ°ç«¯å£æ˜ å°„åˆ°å…¬ç½‘ï¼š

#### ngrok

```bash
# å®‰è£… ngrok: https://ngrok.com/download
ngrok http 9880
# è·å–å…¬ç½‘ URLï¼ˆå¦‚ https://abc123.ngrok-free.appï¼‰
# å°† https://abc123.ngrok-free.app/callback å¡«å…¥ä¼ä¸šå¾®ä¿¡åå°
```

#### frp

```bash
# åœ¨æœ‰å…¬ç½‘ IP çš„æœåŠ¡å™¨ä¸Šéƒ¨ç½² frps
# åœ¨æœ¬åœ°é…ç½® frpc:
[wework]
type = http
local_port = 9880
custom_domains = your-domain.com
```

#### cpolar

```bash
# å®‰è£… cpolar: https://www.cpolar.com/
cpolar http 9880
```

### å¸¸è§é—®é¢˜

- **åˆ›å»ºæœºå™¨äººæ—¶æç¤º"ç½‘ç»œå¤±è´¥"**: å›è°ƒ URL ä¸é€šï¼Œç¡®ä¿ OpenAkita å·²å¯åŠ¨ã€ç«¯å£å·²ç›‘å¬ã€å…¬ç½‘å¯è®¿é—®
- **URL éªŒè¯å¤±è´¥**: ç¡®è®¤ Token å’Œ EncodingAESKey ä¸ä¼ä¸šå¾®ä¿¡åå°ä¸€è‡´
- **ç­¾åæ ¡éªŒå¤±è´¥**: æ£€æŸ¥ Corp ID æ˜¯å¦æ­£ç¡®
- **ç«¯å£è¢«å ç”¨**: ä¿®æ”¹ `WEWORK_CALLBACK_PORT` ä¸ºå…¶ä»–ç«¯å£
- **å†…ç½‘ç©¿é€ä¸ç¨³å®š**: å»ºè®®ä½¿ç”¨ä»˜è´¹ç‰ˆ ngrok æˆ–è‡ªå»º frp
- **æ”¶ä¸åˆ°æ¶ˆæ¯**: ç¡®è®¤æœºå™¨äººå›è°ƒåœ°å€é…ç½®æ­£ç¡®ï¼Œä¸”æœåŠ¡å™¨ç«¯å£å¯è®¿é—®
- **ç¾¤èŠä¸­å…¶ä»–äºº @ä¸å›å¤**: æ£€æŸ¥è¯¥å‘˜å·¥æ˜¯å¦åœ¨æœºå™¨äººçš„ã€Œå¯è§èŒƒå›´ã€å†…
- **å›å¤ä¹±ç **: ç¡®è®¤ stream å›å¤çš„ JSON ä½¿ç”¨äº† `ensure_ascii=False`ï¼ˆé€‚é…å™¨å·²å¤„ç†ï¼‰
- **å›¾ç‰‡å‘ä¸å‡ºæ¥**: ç¡®è®¤å›¾ç‰‡ä¸º JPG/PNG æ ¼å¼ä¸” â‰¤10MBï¼Œstream session æœªè¶…æ—¶

---

## QQ (OneBot åè®®)

### å‰ç½®æ¡ä»¶

- ä¸€ä¸ª QQ è´¦å·
- éƒ¨ç½² OneBot v11 å®ç°ï¼ˆå¦‚ NapCatã€Lagrange.OneBotï¼‰

### éƒ¨ç½² OneBot æœåŠ¡å™¨

OpenAkita é€šè¿‡ OneBot v11 åè®®ä¸ QQ é€šä¿¡ï¼Œéœ€è¦å…ˆéƒ¨ç½²ä¸€ä¸ª OneBot å®ç°ï¼š

#### NapCatï¼ˆæ¨èï¼‰

```bash
# å‚è€ƒ: https://github.com/NapNeko/NapCatQQ
# ä¸‹è½½å¹¶é…ç½® NapCatï¼Œå¯ç”¨æ­£å‘ WebSocket
# é…ç½®æ–‡ä»¶ä¸­è®¾ç½® WebSocket åœ°å€ä¸º ws://127.0.0.1:8080
```

#### Lagrange.OneBot

```bash
# å‚è€ƒ: https://github.com/LagrangeDev/Lagrange.Core
# ä¸‹è½½å¹¶é…ç½®ï¼Œå¯ç”¨æ­£å‘ WebSocket
```

### OpenAkita é…ç½®

```bash
# å®‰è£… QQ ä¾èµ–
pip install openakita[qq]

# .env
QQ_ENABLED=true
QQ_ONEBOT_URL=ws://127.0.0.1:8080
```

### éƒ¨ç½²æ¨¡å¼

- **WebSocket æ­£å‘è¿æ¥**: OpenAkita è¿æ¥åˆ°æœ¬åœ° OneBot æœåŠ¡å™¨ï¼Œæ— éœ€å…¬ç½‘ IP
- æ”¯æŒè‡ªåŠ¨æ–­çº¿é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ç­–ç•¥ï¼‰

### éªŒè¯æ–¹æ³•

1. å…ˆå¯åŠ¨ OneBot æœåŠ¡å™¨ï¼ˆå¦‚ NapCatï¼‰ï¼Œç¡®è®¤ WebSocket ç›‘å¬æ­£å¸¸
2. å¯åŠ¨ OpenAkitaï¼Œæ—¥å¿—åº”æ˜¾ç¤º `QQ adapter connected to ws://127.0.0.1:8080`
3. åœ¨ QQ ä¸­ç»™æœºå™¨äººå‘æ¶ˆæ¯ï¼ˆç§èŠæˆ–ç¾¤èŠ @æœºå™¨äººï¼‰
4. è§‚å¯Ÿæ—¥å¿—å’Œå›å¤

### æ–‡ä»¶å‘é€è¯´æ˜

QQï¼ˆOneBot v11ï¼‰çš„æ–‡ä»¶å‘é€ä¸æ”¯æŒ CQ ç ï¼Œå¿…é¡»ä½¿ç”¨ä¸“ç”¨ APIï¼š
- ç¾¤æ–‡ä»¶: `upload_group_file`
- ç§èŠæ–‡ä»¶: `upload_private_file`

é€‚é…å™¨å·²è‡ªåŠ¨å¤„ç†ï¼Œé€šè¿‡ `deliver_artifacts` å·¥å…·å‘é€æ–‡ä»¶æ—¶æ— éœ€ç‰¹åˆ«æ“ä½œã€‚

### å¸¸è§é—®é¢˜

- **è¿æ¥å¤±è´¥**: ç¡®è®¤ OneBot æœåŠ¡å™¨å·²å¯åŠ¨ä¸” WebSocket åœ°å€æ­£ç¡®
- **æ–­çº¿é‡è¿**: é€‚é…å™¨æ”¯æŒè‡ªåŠ¨é‡è¿ï¼Œåˆå§‹å»¶è¿Ÿ 1 ç§’ï¼Œæœ€å¤§å»¶è¿Ÿ 60 ç§’
- **ç¾¤/ç§èŠåˆ¤æ–­**: é€‚é…å™¨ä¼šæ ¹æ®æ¶ˆæ¯æ¥æºè‡ªåŠ¨åˆ¤æ–­ç¾¤èŠæˆ–ç§èŠ

---

## è¯­éŸ³è¯†åˆ« (Whisper)

æ‰€æœ‰ IM é€šé“çš„è¯­éŸ³æ¶ˆæ¯éƒ½ä¼šç»è¿‡ MessageGateway ç»Ÿä¸€é¢„å¤„ç†ï¼š

1. é€‚é…å™¨å°†è¯­éŸ³æ¶ˆæ¯è§£æä¸º `UnifiedMessage`ï¼ˆåŒ…å« `MediaFile`ï¼‰
2. Gateway è‡ªåŠ¨ä¸‹è½½è¯­éŸ³æ–‡ä»¶åˆ°æœ¬åœ°
3. Gateway è°ƒç”¨ Whisper æ¨¡å‹è¿›è¡Œè¯­éŸ³è½¬æ–‡å­—
4. è½¬å†™ç»“æœå­˜å…¥ `MediaFile.transcription`ï¼Œä¼ é€’ç»™ Agent

### ffmpeg ä¾èµ–

Whisper éœ€è¦ `ffmpeg` æ¥è§£ç éŸ³é¢‘æ–‡ä»¶ã€‚OpenAkita æ”¯æŒè‡ªåŠ¨æ£€æµ‹å’Œå®‰è£…ï¼š

- **å·²å®‰è£… ffmpeg**: è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿ PATH ä¸­çš„ ffmpeg
- **æœªå®‰è£… ffmpeg**: è‡ªåŠ¨é€šè¿‡ `static-ffmpeg` åŒ…ä¸‹è½½é™æ€äºŒè¿›åˆ¶

```bash
# æ‰‹åŠ¨å®‰è£… ffmpegï¼ˆæ¨èï¼‰
# Windows: winget install FFmpeg
# macOS: brew install ffmpeg
# Linux: sudo apt install ffmpeg

# æˆ–é€šè¿‡ Python è‡ªåŠ¨å®‰è£…
pip install static-ffmpeg
```

### Whisper æ¨¡å‹é€‰æ‹©

```bash
# .env
WHISPER_MODEL=base  # tiny/base/small/medium/large
```

| æ¨¡å‹ | å¤§å° | é€Ÿåº¦ | ç²¾åº¦ |
|------|------|------|------|
| tiny | ~39MB | æœ€å¿« | ä¸€èˆ¬ |
| base | ~74MB | å¿« | è¾ƒå¥½ |
| small | ~244MB | ä¸­ç­‰ | å¥½ |
| medium | ~769MB | æ…¢ | å¾ˆå¥½ |
| large | ~1.5GB | æœ€æ…¢ | æœ€å¥½ |

---

## ç»Ÿä¸€å®‰è£…

å®‰è£…æ‰€æœ‰ IM é€šé“ä¾èµ–ï¼š

```bash
pip install openakita[all]
```

æˆ–æŒ‰éœ€å®‰è£…ï¼š

```bash
pip install openakita[feishu]      # é£ä¹¦
pip install openakita[dingtalk]    # é’‰é’‰
pip install openakita[wework]      # ä¼ä¸šå¾®ä¿¡
pip install openakita[qq]          # QQ
pip install openakita[whisper]     # è¯­éŸ³è¯†åˆ«ï¼ˆå« ffmpegï¼‰

# ç»„åˆå®‰è£…
pip install openakita[feishu,dingtalk,whisper]
```

---

## æ¶æ„è¯´æ˜

```
å¹³å°æ¶ˆæ¯ â†’ Adapter (è§£æ) â†’ UnifiedMessage â†’ Gateway (é¢„å¤„ç†) â†’ Agent
                                                    â†“
Agent å›å¤ â† Adapter (å‘é€) â† OutgoingMessage â† Gateway (è·¯ç”±)
```

- **ChannelAdapter**: åŸºç±»å®šä¹‰åœ¨ `src/openakita/channels/base.py`ï¼Œå„å¹³å°å®ç°åœ¨ `src/openakita/channels/adapters/`
- **MessageGateway**: ç»Ÿä¸€æ¶ˆæ¯è·¯ç”±ã€ä¼šè¯ç®¡ç†ã€åª’ä½“é¢„å¤„ç†ï¼Œå®šä¹‰åœ¨ `src/openakita/channels/gateway.py`
- **deliver_artifacts**: Agent å·¥å…·ï¼Œç”¨äºä¸»åŠ¨å‘é€æ–‡ä»¶/å›¾ç‰‡/è¯­éŸ³ï¼Œå®šä¹‰åœ¨ `src/openakita/tools/handlers/im_channel.py`
